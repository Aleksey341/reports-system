<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Форма 1-ГМУ</title>
  <style>
    :root {
      color-scheme: dark light;
      /* Dark theme colors */
      --bg-primary: #0a0d12;
      --bg-secondary: #12161c;
      --bg-tertiary: #1a1d24;
      --border-primary: #2b3444;
      --border-secondary: #232a36;
      --accent-blue: #5a8fff;
      --accent-blue-light: #8ab4ff;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
      --shadow-color: rgba(0,0,0,0.4);
      --input-bg: #0a0d12;

      /* динамический отступ для липкой шапки таблицы */
      --sticky-top: 0px;
    }

    /* Light theme */
    [data-theme="light"] {
      --bg-primary: #f5f7fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e8eef7;
      --border-primary: #d1dae6;
      --border-secondary: #e0e7f0;
      --accent-blue: #2563eb;
      --accent-blue-light: #3b82f6;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --shadow-color: rgba(0,0,0,0.1);
      --input-bg: #ffffff;
    }

    html {
      /* чтобы при появлении/скрытии вертикальной полосы не было горизонтального «рывка» */
      scrollbar-gutter: stable both-edges;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Header with enhanced gradient shadow */
    header{
      position:sticky;
      top:0;
      z-index:100;
      background:var(--bg-secondary);
      border-bottom:1px solid var(--border-secondary);
      padding:24px;
      max-width:1100px;
      margin:auto;
      box-shadow:0 4px 20px var(--shadow-color), 0 8px 40px var(--shadow-color);
    }

    /* Header top row with title and theme toggle */
    .header-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    /* Title with gradient and text shadow */
    h1{
      background:linear-gradient(135deg, var(--accent-blue-light) 0%, var(--accent-blue) 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-size:28px;
      font-weight:700;
      margin:0;
      letter-spacing:-0.5px;
      filter:drop-shadow(0 2px 4px rgba(90,143,255,0.3));
    }

    /* Theme toggle button */
    .theme-toggle{
      background:var(--bg-tertiary);
      border:1px solid var(--border-primary);
      color:var(--text-primary);
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition:all 0.3s ease;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 2px 8px var(--shadow-color);
    }
    .theme-toggle:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px var(--shadow-color);
      border-color:var(--accent-blue);
    }
    .theme-toggle svg{
      width:18px;
      height:18px;
      fill:currentColor;
    }

    main{max-width:1100px;margin:auto;padding:24px}
    a{color:#8ab4ff;text-decoration:none;transition:color 0.2s}
    a:hover{color:#a8c8ff;text-decoration:underline}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px;position:relative}

    /* Labels with animated pulse icons */
    label{
      font-size:13px;
      font-weight:500;
      color:var(--text-secondary);
      letter-spacing:0.3px;
      display:flex;
      align-items:center;
      gap:6px;
      transition:color 0.2s ease;
    }
    label::before{
      content:'';
      display:inline-block;
      width:4px;
      height:4px;
      background:var(--accent-blue);
      border-radius:50%;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{opacity:1; transform:scale(1)}
      50%{opacity:0.6; transform:scale(0.85)}
    }
    .ctl:focus-within label{
      color:var(--accent-blue-light);
    }
    .ctl:focus-within label::before{
      animation:none;
      box-shadow:0 0 6px var(--accent-blue);
    }

    /* Inputs with enhanced focus states and depth */
    select,input[type="number"],input[type="month"]{
      background:var(--input-bg);
      border:1px solid var(--border-primary);
      border-radius:10px;
      color:var(--text-primary);
      padding:12px 14px;
      min-width:220px;
      transition:all 0.3s ease;
      box-shadow:0 2px 8px var(--shadow-color);
    }
    select:focus,input[type="number"]:focus,input[type="month"]:focus{
      outline:none;
      border-color:var(--accent-blue);
      box-shadow:0 0 0 3px rgba(90,143,255,0.15), 0 6px 16px var(--shadow-color);
      background:var(--bg-secondary);
      transform:translateY(-1px);
    }
    select:hover,input[type="number"]:hover,input[type="month"]:hover{
      border-color:var(--accent-blue-light);
      box-shadow:0 4px 12px var(--shadow-color);
    }

    /* Enhanced gradient buttons with multi-layered shadows */
    button{
      background:linear-gradient(135deg, #1b6fff 0%, #1554d1 100%);
      border:0;
      color:#fff;
      padding:12px 20px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.3s ease;
      box-shadow:0 4px 12px rgba(27,111,255,0.3), 0 2px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
      position:relative;
      overflow:hidden;
    }
    button::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition:left 0.5s;
    }
    button:hover::before{
      left:100%;
    }
    button:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 20px rgba(27,111,255,0.45), 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    button:active{
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(27,111,255,0.35), 0 1px 4px rgba(0,0,0,0.2);
    }

    button.secondary{
      background:linear-gradient(135deg, #1e2430 0%, #161b24 100%);
      box-shadow:0 4px 12px rgba(0,0,0,0.3), 0 2px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    button.secondary:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 18px rgba(0,0,0,0.45), 0 4px 8px rgba(0,0,0,0.3);
    }
    button.secondary:active{
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(0,0,0,0.35);
    }

    button:disabled{
      opacity:0.4;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    button:disabled:hover{
      transform:none;
    }

    /* Banner with animations */
    .banner{
      background:linear-gradient(135deg, #2a1620 0%, #1f1218 100%);
      border:1px solid #6a1b2a;
      color:#ffd6de;
      border-radius:10px;
      padding:14px 16px;
      margin:12px 0;
      display:none;
      animation:slideDown 0.3s ease;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    .banner.success{
      background:linear-gradient(135deg, #1a2a20 0%, #141f18 100%);
      border-color:#2a6a3a;
      color:#d6ffd6;
    }
    @keyframes slideDown{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* Модальное окно импорта */
    .import-modal{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      animation:fadeIn 0.3s ease;
    }
    .import-modal.show{
      display:flex;
    }
    .import-modal-content{
      background:linear-gradient(135deg, #1a1f28 0%, #12161c 100%);
      border:1px solid #2b3444;
      border-radius:12px;
      padding:24px;
      max-width:600px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
    }
    .import-modal h3{
      margin:0 0 16px 0;
      color:#8ab4ff;
    }
    .import-file-item{
      background:#0f1318;
      border:1px solid #2b3444;
      border-radius:8px;
      padding:12px;
      margin:8px 0;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .import-file-item .file-name{
      flex:1;
      font-size:13px;
      color:#e8eef7;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .import-file-item .service-name{
      flex:1;
      font-size:12px;
      color:#9fb0c9;
      font-style:italic;
    }
    .import-file-item .status{
      font-size:12px;
      padding:4px 8px;
      border-radius:4px;
      white-space:nowrap;
    }
    .import-file-item .status.pending{
      background:#2a1620;
      color:#ffd6de;
    }
    .import-file-item .status.processing{
      background:#1a2a3a;
      color:#8ab4ff;
    }
    .import-file-item .status.success{
      background:#1a2a20;
      color:#d6ffd6;
    }
    .import-file-item .status.error{
      background:#2a1620;
      color:#ff8a8a;
    }
    .import-progress{
      margin:16px 0;
      font-size:14px;
      color:#9fb0c9;
    }
    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }

    /* Table with enhanced depth and elevation */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
      background:var(--bg-secondary);
      border-radius:12px;
      box-shadow:0 4px 16px var(--shadow-color), 0 8px 32px var(--shadow-color);
    }

    /* Липкий ВЕСЬ thead (не th) + динамический top */
    thead{
      position:sticky;
      top:var(--sticky-top);
      z-index:60;
    }
    table thead th{
      position:relative;
      background:var(--bg-tertiary);
      color:var(--text-secondary);
      font-weight:600;
      border-bottom:2px solid var(--border-primary);
      padding:14px 12px;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:0.8px;
    }

    tbody tr{
      transition:background 0.2s ease, box-shadow 0.2s ease;
    }
    tbody tr:nth-child(even){
      background:var(--bg-tertiary);
    }
    tbody tr:hover{
      background:var(--bg-tertiary);
      box-shadow:0 2px 8px rgba(90,143,255,0.1), 0 4px 16px rgba(90,143,255,0.05);
    }

    td{
      border-bottom:1px solid var(--border-secondary);
      padding:12px;
      text-align:left;
      color:var(--text-primary);
    }

    /* Input fields in table with enhanced focus glow */
    td input[type="number"]{
      min-width:120px;
      padding:8px 12px;
      background:var(--input-bg);
      border:1px solid var(--border-primary);
      border-radius:8px;
      color:var(--text-primary);
      transition:all 0.3s ease;
      box-shadow:0 1px 2px var(--shadow-color);
    }
    td input[type="number"]:focus{
      outline:none;
      border-color:var(--accent-blue);
      box-shadow:0 0 0 3px rgba(90,143,255,0.2), 0 4px 12px rgba(90,143,255,0.15);
      background:var(--bg-secondary);
      transform:translateY(-1px);
    }
    td input[type="number"]:hover{
      border-color:var(--accent-blue-light);
      box-shadow:0 2px 8px var(--shadow-color);
    }

    tfoot td{border:0;padding-top:16px}
    tbody.disabled{opacity:0.4;pointer-events:none}

    /* Custom scrollbar */
    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-track{background:var(--bg-primary)}
    ::-webkit-scrollbar-thumb{
      background:var(--border-primary);
      border-radius:5px;
      transition:background 0.2s;
    }
    ::-webkit-scrollbar-thumb:hover{background:var(--accent-blue)}

    /* Success animation */
    @keyframes successPulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.02)}
      100%{transform:scale(1)}
    }
    .success-animation{
      animation:successPulse 0.5s ease-out;
    }

    /* Loading state */
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    .btn-loading{
      position:relative;
      pointer-events:none;
    }
    .btn-loading::after{
      content:'';
      position:absolute;
      width:16px;
      height:16px;
      top:50%;
      left:50%;
      margin:-8px 0 0 -8px;
      border:2px solid rgba(255,255,255,0.3);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin 0.6s linear infinite;
    }

    /* Fade in animation for page load */
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:translateY(0)}
    }
    main{
      animation:fadeIn 0.5s ease-out;
    }

    /* Auth block in header */
    .auth-block{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:12px;
      padding:12px;
      background:rgba(26,29,36,0.6);
      border-radius:8px;
      border:1px solid #2b3444;
    }
    .user-info{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
    }
    .user-email{
      color:var(--accent-blue-light);
      font-weight:600;
      font-size:14px;
    }
    .user-role{
      background:rgba(90,143,255,0.2);
      color:var(--accent-blue-light);
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
    }
    .auth-block button{
      padding:8px 16px;
      font-size:14px;
    }

    /* Modal */
    .modal-overlay{
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.85);
      z-index:1000;
      animation:fadeIn 0.2s ease;
    }
    .modal-overlay.show{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal{
      background:var(--bg-secondary);
      border:1px solid var(--border-primary);
      border-radius:12px;
      padding:32px;
      min-width:400px;
      max-width:90%;
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
      animation:slideDown 0.3s ease;
    }
    .modal h2{
      margin:0 0 24px 0;
      color:var(--text-primary);
      font-size:24px;
    }
    .modal .ctl{
      margin-bottom:16px;
    }
    .modal input[type="email"],
    .modal input[type="password"]{
      width:100%;
      box-sizing:border-box;
      background:#0a0d12;
      border:1px solid #2b3444;
      border-radius:8px;
      color:#e8eef7;
      padding:12px 14px;
      transition:all 0.3s ease;
    }
    .modal input[type="email"]:focus,
    .modal input[type="password"]:focus{
      outline:none;
      border-color:#5a8fff;
      box-shadow:0 0 0 3px rgba(90,143,255,0.15);
      background:#12161c;
    }
    .modal-buttons{
      display:flex;
      gap:12px;
      margin-top:24px;
    }
    .modal-buttons button{
      flex:1;
    }
    .modal-error{
      color:#ff6b6b;
      font-size:14px;
      margin-top:12px;
      display:none;
    }
    .modal-error.show{
      display:block;
    }
  </style>
</head>
<body>
<header id="page-header">
  <div class="header-top">
    <div>
      <a href="/" aria-label="На главную">← На главную</a>
      <h1>Форма 1-ГМУ (месячная периодичность)</h1>
    </div>
    <button id="theme-toggle" class="theme-toggle" aria-label="Переключить тему">
      <svg id="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg id="theme-icon-moon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
      <span id="theme-text">Светлая</span>
    </button>
  </div>

  <!-- Auth Block -->
  <div class="auth-block" id="auth-block">
    <div class="user-info" id="user-info" style="display:none">
      <span class="user-email" id="user-email"></span>
      <span class="user-role" id="user-role"></span>
      <a href="/admin" id="admin-link" style="display:none">Админ-панель</a>
      <a href="/change-password.html" id="change-password-link" style="display:none">Сменить пароль</a>
    </div>
    <button id="btn-login" style="display:none">Войти</button>
    <button id="btn-logout" class="secondary" style="display:none">Выйти</button>
  </div>

  <div id="banner" class="banner"></div>

  <div class="row" style="margin-top:8px">
    <div class="ctl">
      <label for="period">Отчётный месяц</label>
      <input id="period" type="month" />
    </div>

    <div class="ctl">
      <label for="municipality">Муниципалитет</label>
      <select id="municipality">
        <option value="">Загрузка…</option>
      </select>
    </div>

    <div class="ctl">
      <label for="service-category">Категория услуг</label>
      <select id="service-category">
        <option value="">Загрузка…</option>
      </select>
    </div>

    <div class="ctl">
      <label for="service">Услуга</label>
      <select id="service" disabled>
        <option value="">— выберите категорию —</option>
      </select>
    </div>

    <div class="ctl" style="margin-left:auto;gap:8px">
      <label>&nbsp;</label>
      <div class="row">
        <button id="btn-save" disabled>Сохранить отчёт</button>
        <button id="btn-export" class="secondary" disabled>Скачать Excel</button>
        <button id="btn-import" class="secondary">Импорт из Excel</button>
        <button id="btn-clear" class="secondary" disabled>Очистить форму</button>
      </div>
    </div>
  </div>
</header>

<!-- Модальное окно для множественного импорта -->
<div id="import-modal" class="import-modal">
  <div class="import-modal-content">
    <h3>Импорт файлов</h3>
    <div class="import-progress" id="import-progress">Обработано: 0 / 0</div>
    <div id="import-files-list"></div>
    <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
      <button id="btn-import-cancel" class="secondary">Отмена</button>
      <button id="btn-import-start">Начать импорт</button>
    </div>
  </div>
</div>

<main>
  <input type="file" id="file-import" accept=".xlsx,.xls" multiple style="display:none" />
  <table id="tbl">
    <thead>
      <tr>
        <th style="width:56px">№</th>
        <th>Показатель</th>
        <th style="width:120px">Ед.</th>
        <th style="width:160px">Значение</th>
      </tr>
    </thead>
    <tbody id="tbody" class="disabled">
      <tr><td colspan="4" style="text-align:center;color:#a7b3c6">Выберите услугу для заполнения показателей</td></tr>
    </tbody>
    <tfoot>
      <tr><td colspan="4" class="muted" style="color:#8aa1c0">Навигация: Enter/↓ — вниз, ↑ — вверх.</td></tr>
    </tfoot>
  </table>
</main>

<!-- Login Modal -->
<div class="modal-overlay" id="modal-login">
  <div class="modal">
    <h2>Авторизация</h2>
    <div class="ctl">
      <label for="login-municipality">Муниципалитет</label>
      <select id="login-municipality">
        <option value="">Загрузка...</option>
      </select>
    </div>
    <div class="ctl">
      <label for="login-password">Пароль</label>
      <input type="password" id="login-password" />
    </div>
    <div class="modal-error" id="login-error"></div>
    <div class="modal-buttons">
      <button id="btn-modal-login">Войти</button>
      <button class="secondary" id="btn-modal-cancel">Отмена</button>
    </div>
  </div>
</div>

<script>
/* ===== helpers ===== */
const $ = (s)=>document.querySelector(s);
const banner = $('#banner');

/* ===== динамический отступ для sticky ===== */
const rootEl = document.documentElement;
const headerEl = document.getElementById('page-header');

function updateStickyTop(){
  const h = headerEl ? Math.ceil(headerEl.getBoundingClientRect().height) : 0;
  rootEl.style.setProperty('--sticky-top', `${h}px`);
}

window.addEventListener('load', updateStickyTop);
window.addEventListener('resize', updateStickyTop);
if ('fonts' in document) document.fonts.ready.then(updateStickyTop);
if ('ResizeObserver' in window && headerEl){
  new ResizeObserver(updateStickyTop).observe(headerEl);
}

function showBanner(msg, isSuccess){
  if(!msg){banner.style.display='none'; updateStickyTop(); return;}
  banner.textContent = msg;
  banner.className = isSuccess ? 'banner success' : 'banner';
  banner.style.display='block';
  requestAnimationFrame(updateStickyTop);
}

/* ===== state ===== */
let indicators = [];
let currentUser = null;
let pendingRequest = null; // For retry after login

/* ===== auth functions ===== */
async function checkAuth(){
  try{
    const r = await fetch('/api/auth/me', {credentials: 'include'});
    if(r.ok){
      currentUser = await r.json();
      updateAuthUI();

      // Check if password reset is required
      if(currentUser.password_reset_required){
        window.location.href = '/change-password.html?required=true';
        return false;
      }

      return true;
    } else {
      currentUser = null;
      updateAuthUI();
      return false;
    }
  }catch(e){
    console.error('checkAuth:', e);
    currentUser = null;
    updateAuthUI();
    return false;
  }
}

function updateAuthUI(){
  const btnLogin = $('#btn-login');
  const btnLogout = $('#btn-logout');
  const userInfo = $('#user-info');
  const userEmail = $('#user-email');
  const userRole = $('#user-role');
  const adminLink = $('#admin-link');
  const changePasswordLink = $('#change-password-link');

  if(currentUser){
    btnLogin.style.display = 'none';
    btnLogout.style.display = 'block';
    userInfo.style.display = 'flex';

    // Display municipality name or "Администратор"
    if(currentUser.municipality_name){
      userEmail.textContent = currentUser.municipality_name;
    } else {
      userEmail.textContent = 'Администратор';
    }

    userRole.textContent = currentUser.role;

    if(currentUser.role === 'admin'){
      adminLink.style.display = 'inline';
    } else {
      adminLink.style.display = 'none';
    }

    // Show change password link for all users
    changePasswordLink.style.display = 'inline';
  } else {
    btnLogin.style.display = 'block';
    btnLogout.style.display = 'none';
    userInfo.style.display = 'none';
  }
  requestAnimationFrame(updateStickyTop);
}

async function showLoginModal(){
  $('#modal-login').classList.add('show');
  $('#login-password').value = '';
  $('#login-error').classList.remove('show');
  $('#login-error').textContent = '';

  // Load municipalities for login dropdown
  await loadLoginMunicipalities();

  setTimeout(() => $('#login-municipality').focus(), 100);
}

async function loadLoginMunicipalities(){
  try {
    const r = await fetch('/api/municipalities/all');
    if(!r.ok) throw new Error('Failed to load municipalities');

    const rows = await r.json();
    const sel = $('#login-municipality');
    sel.innerHTML = '<option value="">-- Выберите муниципалитет --</option>';
    sel.innerHTML += '<option value="admin">Администратор</option>';

    rows.forEach(row => {
      const opt = document.createElement('option');
      opt.value = row.id;
      opt.textContent = row.name;
      sel.appendChild(opt);
    });
  } catch(e) {
    console.error('loadLoginMunicipalities:', e);
    $('#login-municipality').innerHTML = '<option value="">Ошибка загрузки</option>';
  }
}

function hideLoginModal(){
  $('#modal-login').classList.remove('show');
}

async function login(municipalityId, password){
  try{
    const r = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({municipality_id: municipalityId, password})
    });

    if(r.ok){
      const data = await r.json();
      currentUser = data.user;
      updateAuthUI();
      hideLoginModal();
      showBanner('Успешная авторизация!', true);
      setTimeout(() => showBanner(''), 2000);

      // Initialize form data after login
      await loadMunicipalities();
      loadServiceCategories();
      loadIndicators();

      // Retry pending request if any
      if(pendingRequest){
        const callback = pendingRequest;
        pendingRequest = null;
        callback();
      }

      return true;
    } else {
      const error = await r.json().catch(() => ({error: 'Ошибка авторизации'}));
      $('#login-error').textContent = error.error || 'Неверный муниципалитет или пароль';
      $('#login-error').classList.add('show');
      return false;
    }
  }catch(e){
    console.error('login:', e);
    $('#login-error').textContent = 'Ошибка соединения с сервером';
    $('#login-error').classList.add('show');
    return false;
  }
}

async function logout(){
  try{
    await fetch('/api/auth/logout', {
      method: 'POST',
      credentials: 'include'
    });
    currentUser = null;
    updateAuthUI();
    showBanner('Вы вышли из системы', true);
    setTimeout(() => showBanner(''), 2000);

    // Reload municipalities (will be empty or all depending on backend)
    await loadMunicipalities();
  }catch(e){
    console.error('logout:', e);
  }
}

/* ===== fetch wrapper with 401 handling ===== */
async function authFetch(url, options = {}){
  const r = await fetch(url, {...options, credentials: 'include'});

  if(r.status === 401){
    // Unauthorized - show login modal
    showLoginModal();
    throw new Error('UNAUTHORIZED');
  }

  return r;
}

/* ===== load municipalities ===== */
async function loadMunicipalities(){
  try{
    const r = await authFetch('/api/my/municipalities');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#municipality');

    if(rows.length === 0){
      sel.innerHTML = '<option value="">Нет доступных муниципалитетов</option>';
      sel.disabled = true;
    } else if(rows.length === 1){
      // Only one municipality - set and disable
      sel.innerHTML = `<option value="${rows[0].id}">${escapeHtml(rows[0].name)}</option>`;
      sel.value = rows[0].id;
      sel.disabled = true;
    } else {
      // Multiple municipalities - let user choose
      sel.innerHTML = '<option value="">— выберите —</option>' +
        rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
      sel.disabled = false;
    }
  }catch(e){
    if(e.message === 'UNAUTHORIZED') return; // Already handled
    console.error('loadMunicipalities:', e);
    showBanner('Ошибка загрузки муниципалитетов');
  }
}

/* ===== load service categories ===== */
async function loadServiceCategories(){
  try{
    const r = await fetch('/api/service-categories');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#service-category');
    if(rows.length === 0){
      sel.innerHTML = '<option value="">Категории не найдены</option>';
      console.warn('Service categories empty. Run: npm run db:init');
      return;
    }
    sel.innerHTML = '<option value="">— выберите —</option>' +
      rows.map(x=>`<option value="${escapeHtml(x.category)}">${escapeHtml(x.category)} (${x.cnt})</option>`).join('');
  }catch(e){
    console.error('loadServiceCategories:', e);
  }
}

/* ===== load services by category ===== */
async function loadServices(category){
  const sel = $('#service');
  try{
    if(!category){
      sel.innerHTML = '<option value="">— выберите категорию —</option>';
      sel.disabled = true;
      updateTableState();
      return;
    }
    const r = await fetch(`/api/services?category=${encodeURIComponent(category)}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    sel.innerHTML = '<option value="">— выберите услугу —</option>' +
      rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
    sel.disabled = false;
    updateTableState();
  }catch(e){
    console.error('loadServices:', e);
    sel.innerHTML = '<option value="">Ошибка загрузки услуг</option>';
    sel.disabled = true;
    updateTableState();
  }
}

/* ===== load indicators for form_1_gmu ===== */
async function loadIndicators(){
  try{
    const r = await fetch('/api/indicators/form_1_gmu');
    if(!r.ok) throw new Error('HTTP '+r.status);
    indicators = await r.json();
    if(indicators.length === 0){
      $('#tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#a7b3c6">Показатели не найдены. Выполните: npm run db:init</td></tr>';
      console.warn('Indicators empty. Run: npm run db:init');
      return;
    }
    renderTable(indicators);
  }catch(e){
    console.error('loadIndicators:', e);
    showBanner('Ошибка загрузки показателей');
    $('#tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#a7b3c6">Не удалось получить показатели.</td></tr>';
  }
}

/* ===== render table ===== */
function renderTable(list){
  const tbody = $('#tbody');
  if(!Array.isArray(list) || list.length===0){
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#a7b3c6">Показатели не найдены.</td></tr>';
    tbody.classList.add('disabled');
    return;
  }
  tbody.innerHTML = list.map((x, i)=>`
    <tr data-id="${x.id}">
      <td>${i+1}</td>
      <td>${escapeHtml(x.name || '')}</td>
      <td>${escapeHtml(x.unit || '')}</td>
      <td><input type="number" step="any" inputmode="decimal" style="width:140px" class="value-input" data-indicator-id="${x.id}" /></td>
    </tr>
  `).join('');

  // Smart auto-navigation
  const inputs = tbody.querySelectorAll('input');
  inputs.forEach((inp, idx) => {
    let autoMoveTimer = null;

    // Enter key navigation
    inp.addEventListener('keydown', e => {
      if(e.key === 'Enter'){
        e.preventDefault();
        const next = inputs[idx + 1];
        if(next) next.focus();
      }
    });

    // Auto-move logic: 1 digit = manual, 2+ digits = auto after 3s
    inp.addEventListener('input', e => {
      clearTimeout(autoMoveTimer);

      const value = e.target.value.replace(/[^\d]/g, ''); // только цифры
      const digitCount = value.length;

      if(digitCount >= 2){
        // 2 и более цифр - автопереход через 3 секунды
        autoMoveTimer = setTimeout(() => {
          const next = inputs[idx + 1];
          if(next) next.focus();
        }, 3000);
      }
      // 1 цифра - переход вручную (Enter или Tab)
    });

    // Отмена таймера при потере фокуса
    inp.addEventListener('blur', () => {
      clearTimeout(autoMoveTimer);
    });
  });
}

/* ===== enable/disable table based on service selection ===== */
function updateTableState(){
  const tbody = $('#tbody');
  const serviceId = $('#service').value;
  const btnSave = $('#btn-save');
  const btnExport = $('#btn-export');
  const btnClear = $('#btn-clear');

  if(serviceId){
    tbody.classList.remove('disabled');
    btnSave.disabled = false;
    btnExport.disabled = false;
    btnClear.disabled = false;
  } else {
    tbody.classList.add('disabled');
    btnSave.disabled = true;
    btnExport.disabled = true;
    btnClear.disabled = true;
  }
}

/* ===== misc ===== */
function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ===== save report ===== */
async function saveReport(){
  // Check auth first
  if(!currentUser){
    pendingRequest = saveReport;
    showLoginModal();
    return;
  }

  const period = $('#period').value;
  const municipalityId = $('#municipality').value;

  if(!period){
    alert('Выберите отчётный месяц');
    return;
  }
  if(!municipalityId){
    alert('Выберите муниципалитет');
    return;
  }

  // Разбор периода: "2025-10" -> year=2025, month=10
  const [year, month] = period.split('-').map(Number);

  // Собираем данные из таблицы
  const values = [];
  document.querySelectorAll('.value-input').forEach(inp => {
    const indicatorId = Number(inp.dataset.indicatorId);
    const value = inp.value ? Number(inp.value) : null;
    if(indicatorId){
      values.push({ indicator_id: indicatorId, value });
    }
  });

  if(values.length === 0){
    alert('Заполните хотя бы одно значение');
    return;
  }

  const payload = {
    municipality_id: Number(municipalityId),
    period_year: year,
    period_month: month,
    values
  };

  try{
    console.log('[FORM] Saving report with payload:', payload);
    showBanner('Сохранение...');
    const r = await authFetch('/api/reports/save', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const result = await r.json();
    console.log('[FORM] Server response:', result);
    console.log('[FORM] Response status:', r.status, r.statusText);

    if(!r.ok){
      const errorMsg = result.detail ? `${result.error}: ${result.detail}` : result.error;
      showBanner(errorMsg || 'Ошибка сохранения');
      console.error('[FORM] Save failed with status', r.status);
      console.error('[FORM] Error details:', JSON.stringify(result, null, 2));
      return;
    }

    showBanner(result.message || 'Отчёт сохранён!', true);
    setTimeout(() => showBanner(''), 3000);
  }catch(e){
    if(e.message === 'UNAUTHORIZED'){
      pendingRequest = saveReport;
      return;
    }
    console.error('[FORM] saveReport error:', e);
    showBanner('Ошибка сохранения отчёта: ' + e.message);
  }
}

/* ===== export to excel ===== */
async function exportToExcel(){
  // Check auth first
  if(!currentUser){
    pendingRequest = exportToExcel;
    showLoginModal();
    return;
  }

  const period = $('#period').value;
  const municipalityId = $('#municipality').value;

  if(!period){
    alert('Выберите отчётный месяц');
    return;
  }
  if(!municipalityId){
    alert('Выберите муниципалитет');
    return;
  }

  const [year, month] = period.split('-').map(Number);

  const exportPayload = {
    municipality_id: Number(municipalityId),
    period_year: year,
    period_month: month
  };

  try{
    console.log('[FORM] Exporting with payload:', exportPayload);
    showBanner('Формирование Excel...');
    const r = await authFetch('/api/reports/export', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(exportPayload)
    });

    console.log('[FORM] Export response status:', r.status, r.statusText);

    if(!r.ok){
      const error = await r.json().catch(() => ({ error: `HTTP ${r.status} ${r.statusText}` }));
      console.error('[FORM] Export failed:', error);
      showBanner(error.error || 'Ошибка экспорта');
      return;
    }

    // Скачиваем файл
    const blob = await r.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Report_${year}_${String(month).padStart(2,'0')}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showBanner('Excel файл загружен!', true);
    setTimeout(() => showBanner(''), 3000);
  }catch(e){
    if(e.message === 'UNAUTHORIZED'){
      pendingRequest = exportToExcel;
      return;
    }
    console.error('exportToExcel:', e);
    showBanner('Ошибка экспорта в Excel');
  }
}

/* ===== import from excel ===== */

// Нормализация строки для сравнения
function normalizeString(s) {
  return (s || "")
    .toLowerCase()
    .replace(/[._\-–—]/g, " ")
    .replace(/[^a-zа-яё0-9\s]/gi, " ")
    .replace(/\s+/g, " ")
    .trim();
}

// Вычисление схожести строк (Jaccard similarity)
function calculateSimilarity(a, b) {
  const tokensA = new Set(normalizeString(a).split(" ").filter(Boolean));
  const tokensB = new Set(normalizeString(b).split(" ").filter(Boolean));

  if (!tokensA.size || !tokensB.size) return 0;

  let intersection = 0;
  for (const token of tokensA) {
    if (tokensB.has(token)) intersection++;
  }

  const union = tokensA.size + tokensB.size - intersection;
  return intersection / union;
}

// Получить все услуги (по всем категориям)
async function fetchAllServices() {
  try {
    const catsRes = await authFetch('/api/service-categories');
    if (!catsRes.ok) throw new Error('Не удалось получить категории');
    const cats = await catsRes.json();

    const allServices = [];
    for (const category of cats) {
      const res = await authFetch('/api/services?category=' + encodeURIComponent(category.category || ''));
      if (res.ok) {
        const services = await res.json();
        allServices.push(...services);
      }
    }
    return allServices;
  } catch(e) {
    if(e.message === 'UNAUTHORIZED') throw e;
    console.error('fetchAllServices:', e);
    throw new Error('Не удалось загрузить список услуг');
  }
}

// Определить услугу по имени файла
async function guessServiceByFilename(filename) {
  try {
    const services = await fetchAllServices();
    let bestMatch = null;
    let bestScore = 0;

    for (const service of services) {
      const score = calculateSimilarity(filename, service.name || '');
      if (score > bestScore) {
        bestScore = score;
        bestMatch = service;
      }
    }

    if (bestMatch && bestScore >= 0.35) {
      const confirmed = confirm(
        `Определена услуга:\n\n${bestMatch.name}\n\nПродолжить импорт?`
      );
      if (!confirmed) return null;
      return bestMatch;
    }

    alert('Не удалось однозначно определить услугу по имени файла.\nВыберите услугу вручную и повторите импорт.');
    return null;
  } catch(e) {
    if(e.message === 'UNAUTHORIZED') throw e;
    throw e;
  }
}

// Отправить файл на сервер
async function uploadImportFile({file, municipalityId, year, month, service}) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('municipality_id', String(municipalityId));
  formData.append('period_year', String(year));
  formData.append('period_month', String(month));

  if (service?.id) formData.append('service_id', String(service.id));
  if (service?.name) formData.append('service_name', service.name);

  const res = await authFetch('/api/import/service-values', {
    method: 'POST',
    body: formData
  });

  let data = null;
  try { data = await res.json(); } catch {}

  if (!res.ok) {
    throw new Error(data?.error || data?.message || `Ошибка импорта (HTTP ${res.status})`);
  }

  return data;
}

// Состояние множественного импорта
let importState = {
  files: [],
  services: [],
  results: [],
  isProcessing: false
};

// Кнопка импорта
async function importFromExcel(){
  const period = $('#period').value;
  const municipalityId = $('#municipality').value;

  if (!period || !municipalityId) {
    alert('Сначала выберите отчётный месяц и муниципалитет.');
    return;
  }

  $('#file-import').click();
}

// Показать модальное окно импорта
function showImportModal() {
  $('#import-modal').classList.add('show');
}

// Скрыть модальное окно импорта
function hideImportModal() {
  $('#import-modal').classList.remove('show');
  importState = { files: [], services: [], results: [], isProcessing: false };
}

// Обновить UI списка файлов
function updateImportFilesList() {
  const container = $('#import-files-list');
  container.innerHTML = '';

  importState.files.forEach((file, index) => {
    const service = importState.services[index];
    const result = importState.results[index];

    const item = document.createElement('div');
    item.className = 'import-file-item';

    let statusHtml = '';
    if (result?.status === 'success') {
      statusHtml = '<span class="status success">✓ Успешно</span>';
    } else if (result?.status === 'error') {
      statusHtml = `<span class="status error">✗ ${result.error || 'Ошибка'}</span>`;
    } else if (result?.status === 'processing') {
      statusHtml = '<span class="status processing">⟳ Обработка...</span>';
    } else {
      statusHtml = '<span class="status pending">Ожидание</span>';
    }

    item.innerHTML = `
      <div class="file-name">${escapeHtml(file.name)}</div>
      <div class="service-name">${service ? escapeHtml(service.name) : 'Определение...'}</div>
      ${statusHtml}
    `;

    container.appendChild(item);
  });

  // Обновить прогресс
  const completed = importState.results.filter(r => r?.status === 'success' || r?.status === 'error').length;
  $('#import-progress').textContent = `Обработано: ${completed} / ${importState.files.length}`;
}

// Обработка выбранных файлов
async function handleFileImport(e){
  const files = Array.from(e.target.files || []);
  e.target.value = ''; // Сброс

  if (!files.length) return;

  // Ограничение до 20 файлов
  if (files.length > 20) {
    alert('Максимум 20 файлов за раз. Выбрано: ' + files.length);
    return;
  }

  try {
    showBanner('Определение услуг по именам файлов…');

    // Инициализация состояния
    importState.files = files;
    importState.services = new Array(files.length).fill(null);
    importState.results = new Array(files.length).fill(null);

    showImportModal();
    updateImportFilesList();

    // Определяем услуги для всех файлов
    const allServices = await fetchAllServices();

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      let bestMatch = null;
      let bestScore = 0;

      for (const service of allServices) {
        const score = calculateSimilarity(file.name, service.name || '');
        if (score > bestScore) {
          bestScore = score;
          bestMatch = service;
        }
      }

      if (bestMatch && bestScore >= 0.35) {
        importState.services[i] = bestMatch;
      } else {
        importState.services[i] = { id: null, name: 'Не определена' };
      }

      updateImportFilesList();
    }

    showBanner('');

  } catch(e) {
    if(e.message === 'UNAUTHORIZED'){
      pendingRequest = () => handleFileImport(e);
      hideImportModal();
      return;
    }
    console.error('handleFileImport:', e);
    showBanner('Ошибка: ' + e.message);
    hideImportModal();
  }
}

// Начать импорт файлов
async function startBatchImport() {
  if (importState.isProcessing) return;

  const period = $('#period').value;
  const municipalityId = Number($('#municipality').value || 0);
  const [year, month] = period.split('-').map(Number);

  importState.isProcessing = true;
  $('#btn-import-start').disabled = true;
  $('#btn-import-cancel').disabled = true;

  let successCount = 0;
  let errorCount = 0;

  for (let i = 0; i < importState.files.length; i++) {
    const file = importState.files[i];
    const service = importState.services[i];

    if (!service || !service.id) {
      importState.results[i] = { status: 'error', error: 'Услуга не определена' };
      errorCount++;
      updateImportFilesList();
      continue;
    }

    try {
      importState.results[i] = { status: 'processing' };
      updateImportFilesList();

      const result = await uploadImportFile({
        file,
        municipalityId,
        year,
        month,
        service
      });

      importState.results[i] = { status: 'success', data: result };
      successCount++;

    } catch(e) {
      if(e.message === 'UNAUTHORIZED'){
        pendingRequest = startBatchImport;
        hideImportModal();
        return;
      }
      console.error(`Import error for ${file.name}:`, e);
      importState.results[i] = { status: 'error', error: e.message };
      errorCount++;
    }

    updateImportFilesList();
  }

  importState.isProcessing = false;
  $('#btn-import-start').disabled = false;
  $('#btn-import-cancel').disabled = false;

  // Итоговое сообщение
  if (successCount > 0 && errorCount === 0) {
    showBanner(`Все файлы импортированы успешно! (${successCount})`, true);
  } else if (successCount > 0 && errorCount > 0) {
    showBanner(`Импортировано: ${successCount}, ошибок: ${errorCount}`);
  } else {
    showBanner(`Импорт не выполнен. Ошибок: ${errorCount}`);
  }

  setTimeout(() => {
    hideImportModal();
  }, 2000);
}

/* ===== clear form ===== */
function clearForm(){
  if(!confirm('Очистить все введённые данные?')) return;
  document.querySelectorAll('.value-input').forEach(inp => inp.value = '');
}

/* ===== event listeners ===== */
$('#service-category').addEventListener('change', e => loadServices(e.target.value));
$('#service').addEventListener('change', updateTableState);
$('#btn-save').addEventListener('click', saveReport);
$('#btn-export').addEventListener('click', exportToExcel);
$('#btn-import').addEventListener('click', importFromExcel);
$('#file-import').addEventListener('change', handleFileImport);
$('#btn-clear').addEventListener('click', clearForm);

// Import modal event listeners
$('#btn-import-start').addEventListener('click', startBatchImport);
$('#btn-import-cancel').addEventListener('click', hideImportModal);

// Auth event listeners
$('#btn-login').addEventListener('click', showLoginModal);
$('#btn-logout').addEventListener('click', logout);
$('#btn-modal-login').addEventListener('click', async () => {
  const municipalityId = $('#login-municipality').value;
  const password = $('#login-password').value;

  if(!municipalityId || !password){
    $('#login-error').textContent = 'Выберите муниципалитет и введите пароль';
    $('#login-error').classList.add('show');
    return;
  }

  await login(municipalityId, password);
});
$('#btn-modal-cancel').addEventListener('click', hideLoginModal);

// Enter key in login form
$('#login-municipality').addEventListener('keypress', e => {
  if(e.key === 'Enter'){
    e.preventDefault();
    $('#login-password').focus();
  }
});
$('#login-password').addEventListener('keypress', e => {
  if(e.key === 'Enter'){
    e.preventDefault();
    $('#btn-modal-login').click();
  }
});

/* ===== Theme Toggle ===== */
function initTheme(){
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeButton(savedTheme);
}

function updateThemeButton(theme){
  const sunIcon = $('#theme-icon-sun');
  const moonIcon = $('#theme-icon-moon');
  const themeText = $('#theme-text');

  if(theme === 'light'){
    sunIcon.style.display = 'none';
    moonIcon.style.display = 'block';
    themeText.textContent = 'Тёмная';
  } else {
    sunIcon.style.display = 'block';
    moonIcon.style.display = 'none';
    themeText.textContent = 'Светлая';
  }
}

function toggleTheme(){
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateThemeButton(newTheme);

  // Update sticky top after theme change (header size might change)
  setTimeout(updateStickyTop, 100);
}

$('#theme-toggle').addEventListener('click', toggleTheme);

/* ===== init ===== */
(async function init(){
  // Initialize theme first
  initTheme();

  // Set default period to current month
  const now = new Date();
  $('#period').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

  // Check auth first
  const isAuth = await checkAuth();

  if(!isAuth){
    // Not authorized - show login modal and stop initialization
    showLoginModal();
    return; // Don't load form data until user logs in
  }

  // Load data on page load
  await loadMunicipalities();
  loadServiceCategories();
  loadIndicators();
})();
</script>
</body>
</html>
