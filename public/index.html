<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å ‚Äî –≥–ª–∞–≤–Ω–∞—è</title>
  <link rel="stylesheet" href="/no-badge.css" />
  <style>
    :root {
      color-scheme: dark light;
      --bg-primary: #0f1115;
      --bg-secondary: #161a22;
      --border: #232a36;
      --text-primary: #e8eef7;
      --text-secondary: #a7b3c6;
      --text-muted: #6a7789;
      --accent-blue: #2563eb;
      --accent-blue-light: #8ab4ff;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
    a{color:var(--accent-blue-light);text-decoration:none} a:hover{text-decoration:underline}
    header,main{max-width:960px;margin:auto;padding:24px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:16px}
    .card{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:12px;
      padding:20px;
      position:relative;
      overflow:hidden;
      transition:all 0.3s ease;
      cursor:pointer;
    }
    .card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:4px;
      background:linear-gradient(90deg,#1b6fff,#8ab4ff);
      transform:scaleX(0);
      transition:transform 0.3s ease;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 24px rgba(37,99,235,0.2);
      border-color:var(--accent-blue);
    }
    .card:hover::before{
      transform:scaleX(1);
    }
    .card-icon{
      font-size:2.5rem;
      margin-bottom:12px;
      opacity:0.9;
      display:inline-block;
      transition:transform 0.3s ease;
    }
    .card:hover .card-icon{
      transform:scale(1.1);
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:1.1rem;
    }
    .card p{
      margin:0 0 16px 0;
      font-size:0.9rem;
      line-height:1.5;
    }
    .card-link{
      color:var(--accent-blue-light);
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:4px;
      transition:gap 0.3s ease;
    }
    .card:hover .card-link{
      gap:8px;
    }
    .muted{color:var(--text-secondary)}
    .stat{font-size:2rem;font-weight:700}
    footer{opacity:.7;padding:24px;text-align:center}

    /* Login modal styles */
    .modal-overlay{
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.85);
      z-index:1000;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(4px);
    }
    .modal-overlay.show{
      display:flex;
      animation:fadeIn 0.2s ease;
    }
    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }
    .modal{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:12px;
      padding:32px;
      min-width:400px;
      max-width:90%;
      animation:slideDown 0.3s ease;
    }
    @keyframes slideDown{
      from{
        transform:translateY(-20px);
        opacity:0;
      }
      to{
        transform:translateY(0);
        opacity:1;
      }
    }
    .modal h2{margin:0 0 24px 0;color:var(--text-primary)}
    .ctl{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}
    label{font-size:13px;font-weight:500;color:var(--text-secondary)}
    select,input[type="password"],input[type="text"]{background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);padding:12px;width:100%;box-sizing:border-box}
    select:focus,input[type="password"]:focus,input[type="text"]:focus{outline:none;border-color:var(--accent-blue)}
    .password-wrapper{position:relative}
    .password-wrapper input{padding-right:40px}
    .toggle-password{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--text-secondary);user-select:none}
    .toggle-password:hover{color:var(--accent-blue-light)}
    button{background:linear-gradient(135deg,#1b6fff 0%,#1554d1 100%);border:0;color:#fff;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;width:100%;margin-top:8px}
    button:hover{opacity:0.9}
    .modal-error{color:#ff6b6b;font-size:14px;margin-top:12px;display:none}
    .modal-error.show{display:block}
    .hidden{display:none !important}

    /* User info header */
    .user-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .user-info{color:var(--text-secondary);font-size:14px}
    .user-info strong{color:var(--accent-blue-light)}
    .btn-logout{
      background:var(--bg-tertiary);
      padding:8px 16px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
      border:1px solid var(--border);
      color:var(--text-primary);
      transition:all 0.2s ease;
    }
    .btn-logout:hover{
      background:var(--border);
      border-color:var(--accent-blue);
    }
  </style>
</head>
<body>

<!-- Login Modal -->
<div class="modal-overlay" id="modal-login">
  <div class="modal">
    <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <div class="ctl">
      <label for="login-municipality">–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</label>
      <select id="login-municipality">
        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
      </select>
    </div>
    <div class="ctl">
      <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
      <div class="password-wrapper">
        <input type="password" id="login-password" />
        <span class="toggle-password" id="toggle-password">üëÅÔ∏è</span>
      </div>
    </div>
    <div class="modal-error" id="login-error"></div>
    <button id="btn-modal-login">–í–æ–π—Ç–∏</button>
    <div style="text-align:center;margin-top:16px">
      <a href="/change-password.html" style="color:var(--accent-blue-light);font-size:14px;text-decoration:none">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a>
    </div>
  </div>
</div>

<div id="main-content" class="hidden">
  <header>
    <div class="user-header">
      <h1>–°–∏—Å—Ç–µ–º–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏</h1>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="user-info">
          <strong id="user-name">‚Äî</strong>
        </div>
        <button id="themeToggle" class="btn-logout">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
        <button class="btn-logout" id="btn-logout">–í—ã–π—Ç–∏</button>
      </div>
    </div>
    <p class="muted">–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:</p>
    <div class="cards" id="cards-container">
      <!-- Cards will be dynamically added based on role -->
    </div>
  </header>

</div>

<footer>
  <span class="muted">¬© –ê–ù–û "–û–±–ª–∞—Å—Ç—å –ë—É–¥—É—â–µ–≥–æ"</span>
</footer>

<script>
const $ = (s) => document.querySelector(s);
let currentUser = null;

// Check auth on page load
async function checkAuth(){
  try{
    const r = await fetch('/api/auth/me', {credentials: 'include'});
    if(r.ok){
      const data = await r.json();
      currentUser = data.user || data; // Handle both {user: {...}} and direct object

      // Check if password reset is required
      if(currentUser.password_reset_required){
        window.location.href = '/change-password.html?required=true';
        return false;
      }

      return true;
    } else {
      return false;
    }
  }catch(e){
    console.error('checkAuth:', e);
    return false;
  }
}

// Show login modal
async function showLoginModal(){
  $('#modal-login').classList.add('show');
  $('#login-password').value = '';
  $('#login-error').classList.remove('show');

  // Load municipalities
  await loadLoginMunicipalities();
  setTimeout(() => $('#login-municipality').focus(), 100);
}

async function loadLoginMunicipalities(){
  try {
    const r = await fetch('/api/municipalities/all');
    if(!r.ok) throw new Error('Failed to load municipalities');

    const rows = await r.json();
    const sel = $('#login-municipality');
    sel.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç --</option>';
    sel.innerHTML += '<option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>';
    sel.innerHTML += '<option value="governor">–ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</option>';

    rows.forEach(row => {
      const opt = document.createElement('option');
      opt.value = row.id;
      opt.textContent = row.name;
      sel.appendChild(opt);
    });
  } catch(e) {
    console.error('loadLoginMunicipalities:', e);
    $('#login-municipality').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
  }
}

// Login
async function login(municipalityId, password){
  try{
    const r = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({municipality_id: municipalityId, password})
    });

    if(r.ok){
      const data = await r.json();
      currentUser = data.user;

      // Check if password reset is required
      if(currentUser.password_reset_required){
        window.location.href = '/change-password.html?required=true';
        return;
      }

      $('#modal-login').classList.remove('show');
      updateUI();
    } else {
      const err = await r.json();
      $('#login-error').textContent = err.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
      $('#login-error').classList.add('show');
    }
  }catch(e){
    console.error('login:', e);
    $('#login-error').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
    $('#login-error').classList.add('show');
  }
}

// Logout
async function logout(){
  try{
    await fetch('/api/auth/logout', {method: 'POST', credentials: 'include'});
    window.location.reload();
  }catch(e){
    console.error('logout:', e);
  }
}

// Update UI based on user role
function updateUI(){
  $('#main-content').classList.remove('hidden');

  // Display name based on role
  if(currentUser.role === 'governor'){
    $('#user-name').textContent = '–ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏';
  } else {
    $('#user-name').textContent = currentUser.municipality_name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
  }

  const cardsContainer = $('#cards-container');
  cardsContainer.innerHTML = '';

  // Cards available for operators (municipalities)
  const operatorCards = [
    {title: '–§–æ—Ä–º–∞ 1-–ì–ú–£', desc: '–í–Ω–µ—Å–µ–Ω–∏–µ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π.', href: '/form', icon: 'üìù'},
    {title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ì–ò–ë–î–î', desc: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Ä–æ–∂–Ω–æ-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏–π.', href: '/gibdd', icon: 'üöó'},
    {title: '–§–∏–Ω–∞–Ω—Å—ã –ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã', desc: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤.', href: '/finance', icon: 'üí∞'}
  ];

  // Admin-only card
  const adminCard = {title: '–û–±—â–∏–π –¥–∞—à–±–æ—Ä–¥', desc: '–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º.', href: '/dashboard', icon: 'üìä'};

  let cards = [];
  if(currentUser.role === 'admin'){
    // Admin sees all cards
    cards = [...operatorCards, adminCard];
  } else if(currentUser.role === 'governor'){
    // Governor sees only dashboard
    cards = [adminCard];
  } else {
    // Operators see only their cards
    cards = operatorCards;
  }

  cards.forEach(card => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="card-icon">${card.icon}</div>
      <h3>${card.title}</h3>
      <p>${card.desc}</p>
      <a href="${card.href}" class="card-link">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</a>
    `;
    cardsContainer.appendChild(div);
  });
}

// Event listeners
$('#btn-modal-login').addEventListener('click', async () => {
  const municipalityId = $('#login-municipality').value;
  const password = $('#login-password').value;

  if(!municipalityId || !password){
    $('#login-error').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç –∏ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
    $('#login-error').classList.add('show');
    return;
  }

  await login(municipalityId, password);
});

$('#login-password').addEventListener('keypress', e => {
  if(e.key === 'Enter'){
    e.preventDefault();
    $('#btn-modal-login').click();
  }
});

$('#btn-logout').addEventListener('click', logout);

// Toggle password visibility
$('#toggle-password').addEventListener('click', () => {
  const input = $('#login-password');
  const toggle = $('#toggle-password');

  if(input.type === 'password'){
    input.type = 'text';
    toggle.textContent = 'üôà';
  } else {
    input.type = 'password';
    toggle.textContent = 'üëÅÔ∏è';
  }
});

// Initialize
(async function init(){
  const isAuth = await checkAuth();

  if(!isAuth){
    showLoginModal();
  } else {
    updateUI();
  }
})();
</script>
<script src="/theme.js"></script>
</body>
</html>
